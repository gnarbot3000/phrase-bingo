<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phrase Bingo</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4F46E5">
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.7/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .btn-primary { background-color: #4F46E5; transition: all 0.3s; }
    .btn-primary:hover { background-color: #4338CA; transform: scale(1.05); }
    .bingo-tile { transition: background-color 0.3s; }
    .bingo-tile:hover { background-color: #E5E7EB; }
    .bingo-tile-marked { background-color: #A5B4FC; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4F46E5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(err => console.error('Service Worker error:', err));
    }
  </script>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Error Boundary Component
    class ErrorBoundary extends React.Component {
      state = { error: null };
      static getDerivedStateFromError(error) {
        console.error("ErrorBoundary caught:", error);
        return { error: error.message };
      }
      render() {
        if (this.state.error) {
          return (
            <div className="p-4 text-red-500 bg-red-100 rounded-lg m-4">
              <h1 className="text-xl font-bold">Error: {this.state.error}</h1>
              <p>Check the console (F12). Ensure Firebase/Stripe configs are set. Test via http://localhost:8000.</p>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // Firebase configuration (replace with your Firebase project config)
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBwX5eCY2TBesBb7oF6SPieZNicA-v-t1o",
  authDomain: "phrase-bingo.firebaseapp.com",
  projectId: "phrase-bingo",
  storageBucket: "phrase-bingo.firebasestorage.app",
  messagingSenderId: "988552731480",
  appId: "1:988552731480:web:e056f7e2ec7273e6a1232d",
  measurementId: "G-W5QTNBLM6Q"
};

    // Initialize Firebase
    let db = null;
    try {
      const app = firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    } catch (error) {
      console.error("Firebase init failed:", error);
    }

    // Stripe initialization
    let stripe = null;
    try {
      stripe = Stripe(pk_test_51RMxmOIJsql3rzJm4X298jkj6sSE03qawwVc0g72HdyzFxaembdpopa5z68HOyLuCLkgcPBV5i9cP0WaysoZB7qq000aObphvV);
    } catch (error) {
      console.error("Stripe init failed:", error);
    }

    const App = () => {
      const [gameCode, setGameCode] = useState('');
      const [phrases, setPhrases] = useState([]);
      const [newPhrase, setNewPhrase] = useState('');
      const [nickname, setNickname] = useState('');
      const [isHost, setIsHost] = useState(false);
      const [bingoGrid, setBingoGrid] = useState([]);
      const [markedTiles, setMarkedTiles] = useState([]);
      const [isPremium, setIsPremium] = useState(false);
      const [debugMessage, setDebugMessage] = useState('');
      const [isLoading, setIsLoading] = useState(false);
      const [hasBingo, setHasBingo] = useState(false);

      // Generate random 5x5 bingo grid
      const generateBingoGrid = (phrases) => {
        if (phrases.length < 24) {
          setDebugMessage('Need at least 24 phrases for the bingo grid.');
          return [];
        }
        const shuffled = [...phrases].sort(() => Math.random() - 0.5).slice(0, 24);
        const grid = Array(5).fill().map(() => Array(5).fill(null));
        let index = 0;
        for (let i = 0; i < 5; i++) {
          for (let j = 0; j < 5; j++) {
            if (i === 2 && j === 2) grid[i][j] = 'FREE';
            else grid[i][j] = shuffled[index++] || '';
          }
        }
        return grid;
      };

      // Check for bingo
      const checkBingo = (marked) => {
        const rows = Array(5).fill(0);
        const cols = Array(5).fill(0);
        let diag1 = 0, diag2 = 0;
        marked.forEach(([r, c]) => {
          rows[r]++;
          cols[c]++;
          if (r === c) diag1++;
          if (r + c === 4) diag2++;
        });
        if (rows.includes(5) || cols.includes(5) || diag1 === 5 || diag2 === 5) {
          setHasBingo(true);
          alert('Bingo! You won!');
        }
      };

      // Create a new game
      const createGame = async () => {
        if (!db) {
          setDebugMessage("Firebase not initialized. Set your config in index.html.");
          return;
        }
        if (phrases.length < 24) {
          setDebugMessage("Add at least 24 phrases to create a game.");
          return;
        }
        setIsLoading(true);
        try {
          const code = Math.random().toString(36).substring(2, 8).toUpperCase();
          await db.collection('games').doc(code).set({
            phrases,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert(`Game created! Code: ${code}`);
          setGameCode(code);
          setIsHost(true);
          setBingoGrid(generateBingoGrid(phrases));
        } catch (error) {
          console.error("Create game error:", error);
          setDebugMessage("Failed to create game. Check console (F12).");
        }
        setIsLoading(false);
      };

      // Add a phrase
      const addPhrase = () => {
        if (newPhrase.trim()) {
          setPhrases([...phrases, newPhrase]);
          setNewPhrase('');
        }
      };

      // Join a game
      const joinGame = async () => {
        if (!db) {
          setDebugMessage("Firebase not initialized. Set your config in index.html.");
          return;
        }
        if (gameCode && nickname) {
          setIsLoading(true);
          try {
            const gameRef = db.collection('games').doc(gameCode);
            const doc = await gameRef.get();
            if (doc.exists) {
              alert(`Joined game as ${nickname}!`);
              setPhrases(doc.data().phrases);
              setBingoGrid(generateBingoGrid(doc.data().phrases));
              // Listen for phrase confirmations
              gameRef.collection('confirmations').onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                  if (change.type === 'added') {
                    const { phrase, player } = change.doc.data();
                    if (player !== nickname) {
                      if (window.confirm(`${player} marked "${phrase}". Confirm?`)) {
                        setMarkedTiles(prev => [...prev, [bingoGrid.flat().indexOf(phrase) / 5 | 0, bingoGrid.flat().indexOf(phrase) % 5]]);
                        checkBingo([...markedTiles, [bingoGrid.flat().indexOf(phrase) / 5 | 0, bingoGrid.flat().indexOf(phrase) % 5]]);
                      }
                    }
                  }
                });
              });
            } else {
              setDebugMessage('Invalid game code.');
            }
          } catch (error) {
            console.error("Join game error:", error);
            setDebugMessage("Failed to join game. Check console (F12).");
          }
          setIsLoading(false);
        } else {
          setDebugMessage('Enter both a game code and nickname.');
        }
      };

      // Mark and confirm phrase
      const confirmPhrase = async (row, col) => {
        if (!db) {
          setDebugMessage("Firebase not initialized. Set your config.");
          return;
        }
        const phrase = bingoGrid[row][col];
        if (phrase === 'FREE' || markedTiles.some(([r, c]) => r === row && c === col)) return;
        try {
          await db.collection('games').doc(gameCode).collection('confirmations').add({
            phrase,
            player: nickname,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          setMarkedTiles(prev => [...prev, [row, col]]);
          checkBingo([...markedTiles, [row, col]]);
        } catch (error) {
          console.error("Confirm phrase error:", error);
          setDebugMessage("Failed to mark phrase. Check console.");
        }
      };

      // Purchase premium
      const buyPremium = async () => {
        if (!stripe) {
          setDebugMessage("Stripe not initialized. Set your key in index.html.");
          return;
        }
        setIsLoading(true);
        try {
          const response = await fetch('https://us-central1-YOUR_PROJECT_ID.cloudfunctions.net/createCheckoutSession');
          const { id } = await response.json();
          stripe.redirectToCheckout({ sessionId: id });
        } catch (error) {
          console.error("Stripe error:", error);
          setDebugMessage("Payment failed. Check console (F12).");
          setIsPremium(true); // For testing without Stripe
        }
        setIsLoading(false);
      };

      // Reset game for testing
      const resetGame = () => {
        setGameCode('');
        setPhrases([]);
        setNewPhrase('');
        setNickname('');
        setIsHost(false);
        setBingoGrid([]);
        setMarkedTiles([]);
        setHasBingo(false);
        setDebugMessage('');
      };

      return (
        <div className="container mx-auto p-6 bg-white rounded-lg shadow-lg max-w-2xl">
          <div className="flex items-center justify-center mb-4">
            <img src="/logo.png" alt="Phrase Bingo Logo" className="h-12 mr-2" onError={() => console.log('Logo not found; upload to Vercel')} />
            <h1 className="text-4xl font-bold text-indigo-600">Phrase Bingo</h1>
          </div>

          {/* Welcome Message */}
          <div className="bg-indigo-50 p-4 rounded-lg mb-6">
            <h2 className="text-lg font-semibold text-indigo-700">How to Play</h2>
            <p className="text-gray-700">
              Create a game with 24+ phrases your family says, or join with a code. Mark phrases as others confirm them to win bingo!
            </p>
          </div>

          {/* Debug Message */}
          {debugMessage && (
            <div className="bg-yellow-100 p-3 mb-4 text-yellow-800 rounded-lg">
              {debugMessage}
            </div>
          )}

          {/* Loading Spinner */}
          {isLoading && (
            <div className="flex justify-center mb-4">
              <div className="spinner"></div>
            </div>
          )}

          {/* AdSense Placeholder */}
          {!isPremium && (
            <div className="bg-gray-200 p-4 mb-6 text-center rounded-lg">
  <ins class="adsbygoogle" style="display:block" data-ad-client="your-ad-client-id" data-ad-slot="your-ad-slot-id" data-ad-format="auto"></ins>
  <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</div>
          )}

          {/* Create Game Section */}
          {!gameCode && (
            <div className="mb-8">
              <h2 className="text-2xl font-semibold text-gray-800 mb-3">Create a New Game</h2>
              <input
                type="text"
                value={newPhrase}
                onChange={(e) => setNewPhrase(e.target.value)}
                placeholder="Enter a phrase (e.g., 'Back in my day')"
                className="border border-gray-300 p-3 w-full rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
              <button
                onClick={addPhrase}
                className="btn-primary text-white p-3 rounded-lg w-full"
              >
                Add Phrase
              </button>
              <div className="my-3">
                <h3 className="font-semibold text-gray-800">Phrases ({phrases.length}/24):</h3>
                <ul className="list-disc pl-5">
                  {phrases.map((phrase, index) => (
                    <li key={index} className="text-gray-700">{phrase}</li>
                  ))}
                </ul>
              </div>
              <button
                onClick={createGame}
                className="btn-primary text-white p-3 rounded-lg w-full"
                disabled={phrases.length < 24 || isLoading}
              >
                Create Game
              </button>
            </div>
          )}

          {/* Join Game Section */}
          {!gameCode && (
            <div className="mb-8">
              <h2 className="text-2xl font-semibold text-gray-800 mb-3">Join a Game</h2>
              <input
                type="text"
                value={gameCode}
                onChange={(e) => setGameCode(e.target.value.toUpperCase())}
                placeholder="Enter game code"
                className="border border-gray-300 p-3 w-full rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
              <input
                type="text"
                value={nickname}
                onChange={(e) => setNickname(e.target.value)}
                placeholder="Enter your nickname"
                className="border border-gray-300 p-3 w-full rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
              <button
                onClick={joinGame}
                className="btn-primary text-white p-3 rounded-lg w-full"
                disabled={isLoading}
              >
                Join Game
              </button>
            </div>
          )}

          {/* Bingo Grid */}
          {bingoGrid.length > 0 && (
            <div className="mt-8">
              <h2 className="text-2xl font-semibold text-gray-800 mb-3">Your Bingo Grid</h2>
              <div className="grid grid-cols-5 gap-1">
                {bingoGrid.map((row, rowIndex) =>
                  row.map((phrase, colIndex) => (
                    <button
                      key={`${rowIndex}-${colIndex}`}
                      onClick={() => confirmPhrase(rowIndex, colIndex)}
                      className={`bingo-tile border border-gray-300 p-3 text-center h-20 rounded-lg text-sm font-medium text-gray-700 ${
                        markedTiles.some(([r, c]) => r === rowIndex && c === colIndex) ? 'bingo-tile-marked' : ''
                      }`}
                      disabled={phrase === 'FREE' || hasBingo}
                    >
                      {phrase}
                    </button>
                  ))
                )}
              </div>
              <button
                onClick={resetGame}
                className="btn-primary text-white p-3 rounded-lg w-full mt-4"
              >
                Reset Game
              </button>
            </div>
          )}

          {/* Premium Purchase */}
          {!isPremium && (
            <div className="mt-8">
              <h2 className="text-2xl font-semibold text-gray-800 mb-3">Go Premium</h2>
              <p className="text-gray-700 mb-3">Remove ads and save phrase lists for $3 (one-time).</p>
              <button
                onClick={buyPremium}
                className="btn-primary text-white p-3 rounded-lg w-full"
                disabled={isLoading}
              >
                Buy Premium
              </button>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>,
      document.getElementById('root')
    );
  </script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=your-ad-client-id" crossorigin="anonymous"></script>
</body>
</html>